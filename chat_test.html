<!DOCTYPE html>
<html>
<head>
  <meta charset="UTF-8">
  <title>Chat Test</title>
  <script src="https://cdn.socket.io/4.5.4/socket.io.min.js"></script>
  <style>
    body { font-family: Arial; padding: 20px; background: #f0f0f0; }
    .container { max-width: 1200px; margin: 0 auto; }
    h1 { text-align: center; color: #333; }
    .loading { text-align: center; padding: 40px; font-size: 18px; }
    .chat-container { display: grid; grid-template-columns: 1fr 1fr; gap: 20px; margin-top: 20px; }
    .user-box { background: white; padding: 20px; border-radius: 10px; box-shadow: 0 2px 10px rgba(0,0,0,0.1); }
    .user-box h2 { color: #667eea; margin-bottom: 15px; }
    .status { padding: 10px; border-radius: 5px; margin-bottom: 15px; font-weight: 600; }
    .status.connected { background: #d4edda; color: #155724; }
    .status.disconnected { background: #f8d7da; color: #721c24; }
    button { background: #667eea; color: white; border: none; padding: 10px 20px; border-radius: 5px; cursor: pointer; margin: 5px 5px 5px 0; }
    button:hover { background: #5568d3; }
    button:disabled { background: #ccc; cursor: not-allowed; }
    .input-group { display: flex; gap: 10px; margin: 15px 0; }
    input { flex: 1; padding: 10px; border: 2px solid #ddd; border-radius: 5px; }
    .messages { background: #f8f9fa; border-radius: 5px; padding: 15px; height: 350px; overflow-y: auto; margin-top: 15px; }
    .message { padding: 10px; margin: 8px 0; border-radius: 8px; background: white; box-shadow: 0 1px 3px rgba(0,0,0,0.1); }
    .message .sender { font-weight: bold; color: #667eea; margin-bottom: 3px; font-size: 13px; }
    .message .time { font-size: 11px; color: #999; margin-top: 3px; }
    .system { text-align: center; color: #6c757d; font-size: 12px; padding: 5px; background: #e9ecef; border-radius: 15px; margin: 5px 0; }
    .error { background: #f8d7da; color: #721c24; padding: 15px; border-radius: 5px; margin: 20px 0; }
  </style>
</head>
<body>
  <div class="container">
    <h1>Real-time Chat Test</h1>
    
    <div id="loading" class="loading">
      Loading configuration...
    </div>

    <div id="error" class="error" style="display: none;"></div>
    
    <div id="chatApp" style="display: none;">
      <div class="chat-container">
        <!-- Ahmed -->
        <div class="user-box">
          <h2>Ahmed</h2>
          <div id="statusAhmed" class="status disconnected">Disconnected</div>
          <div>
            <button onclick="connectAhmed()">Connect</button>
            <button onclick="joinAhmed()">Join Chat</button>
          </div>
          <div class="input-group">
            <input id="msgAhmed" placeholder="Type message..." onkeypress="if(event.key==='Enter') sendAhmed()" />
            <button onclick="sendAhmed()">Send</button>
          </div>
          <div class="messages" id="msgsAhmed"></div>
        </div>

        <!-- Sara -->
        <div class="user-box">
          <h2>Sara</h2>
          <div id="statusSara" class="status disconnected">Disconnected</div>
          <div>
            <button onclick="connectSara()">Connect</button>
            <button onclick="joinSara()">Join Chat</button>
          </div>
          <div class="input-group">
            <input id="msgSara" placeholder="Type message..." onkeypress="if(event.key==='Enter') sendSara()" />
            <button onclick="sendSara()">Send</button>
          </div>
          <div class="messages" id="msgsSara"></div>
        </div>
      </div>
    </div>
  </div>

  <script>
    // Config will be loaded from server
    let SERVER_URL;
    let AHMED_TOKEN;
    let SARA_TOKEN;
    let CONV_ID;

    let socketAhmed, socketSara;

    //Load config from server
    async function loadConfig() {
      try {
        const response = await fetch('http://localhost:9000');
        
        if (!response.ok) {
          throw new Error(`HTTP error! status: ${response.status}`);
        }
        
        const config = await response.json();
        
        SERVER_URL = config.serverUrl;
        AHMED_TOKEN = config.testTokens.ahmed;
        SARA_TOKEN = config.testTokens.sara;
        CONV_ID = config.testConversationId;
        
        console.log('Config loaded successfully');
        console.log('Server URL:', SERVER_URL);
        document.getElementById('loading').style.display = 'none';
        document.getElementById('chatApp').style.display = 'block';
        
      } catch (err) {
        console.error('Failed to load config:', err);
        document.getElementById('loading').style.display = 'none';
        const errorEl = document.getElementById('error');
        errorEl.textContent = 'Failed to load configuration. Make sure the server is running on http://localhost:9000';
        errorEl.style.display = 'block';
      }
    }

    // Load config when page loads
    window.addEventListener('DOMContentLoaded', loadConfig);

    // Ahmed Functions
    function connectAhmed() {
      if (!SERVER_URL) {
        alert('Configuration not loaded yet!');
        return;
      }

      console.log('Connecting Ahmed to', SERVER_URL);
      
      socketAhmed = io(SERVER_URL, {
        auth: { token: AHMED_TOKEN }
      });

      socketAhmed.on('connect', () => {
        console.log('Ahmed connected:', socketAhmed.id);
        updateStatus('statusAhmed', true);
        addSystemMsg('msgsAhmed', 'Connected!');
      });

      socketAhmed.on('connect_error', (err) => {
        console.error('Ahmed connection error:', err);
        updateStatus('statusAhmed', false);
        addSystemMsg('msgsAhmed', JSON.stringify(err));
      });

      socketAhmed.on('disconnect', () => {
        console.log('Ahmed disconnected');
        updateStatus('statusAhmed', false);
        addSystemMsg('msgsAhmed', 'Disconnected');
      });

      socketAhmed.on('receiveMessage', (msg) => {
        console.log('Ahmed received:', msg);
        addReceivedMsg('msgsAhmed', msg);
      });

      socketAhmed.on('joinedConversation', () => {
        console.log('Ahmed joined');
        addSystemMsg('msgsAhmed', 'Joined conversation');
      });

      socketAhmed.on('errorMessage', (err) => {
        console.error('Ahmed error:', err);
        addSystemMsg('msgsAhmed', JSON.stringify(err));
      });
    }

    function joinAhmed() {
      if (!socketAhmed?.connected) {
        alert('Please connect first!');
        return;
      }
      console.log('Ahmed joining conversation:', CONV_ID);
      socketAhmed.emit('joinConversation', CONV_ID);
    }

    function sendAhmed() {
      const input = document.getElementById('msgAhmed');
      const text = input.value.trim();
      if (!text) return;
      
      if (!socketAhmed?.connected) {
        alert('Please connect first!');
        return;
      }

      console.log('Ahmed sending:', text);
      socketAhmed.emit('sendMessage', {
        conversationId: CONV_ID,
        text: text
      });
      input.value = '';
    }

    // Sara Functions
    function connectSara() {
      if (!SERVER_URL) {
        alert('Configuration not loaded yet!');
        return;
      }

      console.log('Connecting Sara to', SERVER_URL);
      
      socketSara = io(SERVER_URL, {
        auth: { token: SARA_TOKEN }
      });

      socketSara.on('connect', () => {
        console.log('Sara connected:', socketSara.id);
        updateStatus('statusSara', true);
        addSystemMsg('msgsSara', 'Connected!');
      });

      socketSara.on('connect_error', (err) => {
        console.error('Sara connection error:', err);
        updateStatus('statusSara', false);
        addSystemMsg('msgsSara', JSON.stringify(err));
      });

      socketSara.on('disconnect', () => {
        console.log('Sara disconnected');
        updateStatus('statusSara', false);
        addSystemMsg('msgsSara', 'Disconnected');
      });

      socketSara.on('receiveMessage', (msg) => {
        console.log('Sara received:', msg);
        addReceivedMsg('msgsSara', msg);
      });

      socketSara.on('joinedConversation', () => {
        console.log('Sara joined');
        addSystemMsg('msgsSara', 'Joined conversation');
      });

      socketSara.on('errorMessage', (err) => {
        console.error('Sara error:', err);
        addSystemMsg('msgsSara', JSON.stringify(err));
      });
    }

    function joinSara() {
      if (!socketSara?.connected) {
        alert('Please connect first!');
        return;
      }
      console.log('Sara joining conversation:', CONV_ID);
      socketSara.emit('joinConversation', CONV_ID);
    }

    function sendSara() {
      const input = document.getElementById('msgSara');
      const text = input.value.trim();
      if (!text) return;
      
      if (!socketSara?.connected) {
        alert('Please connect first!');
        return;
      }

      console.log('Sara sending:', text);
      socketSara.emit('sendMessage', {
        conversationId: CONV_ID,
        text: text
      });
      input.value = '';
    }

    // Helper Functions
    function updateStatus(statusId, connected) {
      const el = document.getElementById(statusId);
      if (connected) {
        el.textContent = 'Connected';
        el.className = 'status connected';
      } else {
        el.textContent = 'Disconnected';
        el.className = 'status disconnected';
      }
    }

    function addSystemMsg(divId, text) {
      const div = document.getElementById(divId);
      const msg = document.createElement('div');
      msg.className = 'system';
      msg.textContent = `${text} â€¢ ${new Date().toLocaleTimeString()}`;
      div.appendChild(msg);
      div.scrollTop = div.scrollHeight;
    }

    function addReceivedMsg(divId, msgData) {
      const div = document.getElementById(divId);
      const msg = document.createElement('div');
      msg.className = 'message';
      msg.innerHTML = `
        <div class="sender">${msgData.sender.name}</div>
        <div>${msgData.text}</div>
        <div class="time">${new Date(msgData.createdAt).toLocaleTimeString()}</div>
      `;
      div.appendChild(msg);
      div.scrollTop = div.scrollHeight;
    }
  </script>
</body>
</html>
